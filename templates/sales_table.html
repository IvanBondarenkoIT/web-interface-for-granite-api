{% extends "base.html" %}

{% block content %}
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
    <div>
      <h1 class="h3 mb-1">Детализация продаж</h1>
      <p class="text-muted mb-0">Загрузите данные перед фильтрацией и сортировкой.</p>
    </div>
    <div class="mt-3 mt-md-0">
      <a href="{{ url_for('sales', load=1, start_date=filters.start_date, end_date=filters.end_date, sort=filters.sort) }}" class="btn btn-primary">
        Загрузить данные
      </a>
    </div>
  </div>

  {% if loaded %}
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <form class="row g-3 align-items-end" method="get" action="{{ url_for('sales') }}">
          <input type="hidden" name="load" value="1">
          <div class="col-12 col-md-3">
            <label for="start_date" class="form-label">Дата начала</label>
            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ filters.start_date }}">
          </div>
          <div class="col-12 col-md-3">
            <label for="end_date" class="form-label">Дата окончания</label>
            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ filters.end_date }}">
          </div>
          <div class="col-12 col-md-4">
            <label for="store" class="form-label">Магазин</label>
            <select class="form-select" id="store" name="store">
              <option value="">Все магазины</option>
              {% for store in stores %}
                <option value="{{ store.ID }}" {% if store.ID in filters.store_ids %}selected{% endif %}>{{ store.NAME }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-2">
            <label for="sort" class="form-label">Сортировка</label>
            <select class="form-select" id="sort" name="sort">
              <option value="date" {% if filters.sort == 'date' %}selected{% endif %}>По дате</option>
              <option value="store" {% if filters.sort == 'store' %}selected{% endif %}>По магазину</option>
              <option value="sum" {% if filters.sort == 'sum' %}selected{% endif %}>По выручке</option>
              <option value="cups" {% if filters.sort == 'cups' %}selected{% endif %}>По чашкам</option>
              <option value="packages" {% if filters.sort == 'packages' %}selected{% endif %}>По упаковкам</option>
            </select>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">Обновить</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('sales', load=1) }}">Сбросить</a>
          </div>
        </form>
      </div>
    </div>

    <div class="row mb-4 g-3">
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <span class="metric-label">Магазины</span>
          <span class="metric-value">{{ summary.stores_count or 0 }}</span>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <span class="metric-label">Чашки</span>
          <span class="metric-value">{{ '{:,}'.format(summary.total_cups or 0).replace(',', ' ') }}</span>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <span class="metric-label">Выручка, ₾</span>
          <span class="metric-value">{{ '{:,.2f}'.format(summary.total_cash or 0).replace(',', ' ') }}</span>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <span class="metric-label">Упаковки, кг</span>
          <span class="metric-value">{{ '{:,.2f}'.format(summary.total_packages or 0).replace(',', ' ') }}</span>
        </div>
      </div>
    </div>

    {% if pivot and pivot.dates %}
      <div class="card shadow-sm">
        <div class="table-responsive">
          <table class="table table-bordered table-hover mb-0 align-middle pivot-table">
            <thead class="table-light">
              <tr>
                <th class="align-middle">Дата</th>
                {% for store_name in pivot.stores %}
                  <th class="text-center align-middle">{{ store_name }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for current_date in pivot.dates %}
                <tr>
                  <th class="align-middle">{{ current_date.isoformat() }}</th>
                  {% for store_name in pivot.stores %}
                    {% set cell = pivot.data.get(current_date, {}).get(store_name) %}
                    <td class="pivot-cell">
                      {% if cell %}
                        <div><span class="pivot-label">Чашки:</span> {{ cell.cups }}</div>
                        <div><span class="pivot-label">Кг:</span> {{ '{:,.2f}'.format(cell.packages_kg).replace(',', ' ') }}</div>
                        <div><span class="pivot-label">₾:</span> {{ '{:,.2f}'.format(cell.total_cash).replace(',', ' ') }}</div>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="card shadow-sm">
        <div class="card-body text-center text-muted py-5">
          Данные по выбранным фильтрам отсутствуют.
        </div>
      </div>
    {% endif %}
  {% else %}
    <div class="card shadow-sm">
      <div class="card-body text-center py-5">
        <p class="lead mb-3">Данные пока не загружены.</p>
        <p class="text-muted mb-4">Мы не обращаемся к Proxy API автоматически. Нажмите кнопку выше, чтобы получить детальную статистику.</p>
        <a href="{{ url_for('sales', load=1, start_date=filters.start_date, end_date=filters.end_date, sort=filters.sort) }}" class="btn btn-primary btn-lg">Загрузить данные</a>
      </div>
    </div>
  {% endif %}
{% endblock %}

