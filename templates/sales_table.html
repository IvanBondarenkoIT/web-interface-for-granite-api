{% extends "base.html" %}

{% block content %}
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
    <div>
      <h1 class="h3 mb-1">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂</h1>
      <p class="text-muted mb-0">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π.</p>
    </div>
    <div class="mt-3 mt-md-0">
      <a href="{{ url_for('sales', load=1, start_date=filters.start_date, end_date=filters.end_date, sort=filters.sort) }}" class="btn btn-primary">
        –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      </a>
    </div>
  </div>

  {% if loaded %}
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <form class="row g-3 align-items-end" method="get" action="{{ url_for('sales') }}">
          <input type="hidden" name="load" value="1">
          <div class="col-12 col-md-3">
            <label for="start_date" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ filters.start_date }}">
          </div>
          <div class="col-12 col-md-3">
            <label for="end_date" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ filters.end_date }}">
          </div>
          <div class="col-12 col-md-4">
            <label for="store" class="form-label">–ú–∞–≥–∞–∑–∏–Ω</label>
            <select class="form-select" id="store" name="store">
              <option value="">–í—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã</option>
              {% for store in stores %}
                <option value="{{ store.ID }}" {% if store.ID in filters.store_ids %}selected{% endif %}>{{ store.NAME }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-2">
            <label for="sort" class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select class="form-select" id="sort" name="sort">
              <option value="date" {% if filters.sort == 'date' %}selected{% endif %}>–ü–æ –¥–∞—Ç–µ</option>
              <option value="store" {% if filters.sort == 'store' %}selected{% endif %}>–ü–æ –º–∞–≥–∞–∑–∏–Ω—É</option>
              <option value="sum" {% if filters.sort == 'sum' %}selected{% endif %}>–ü–æ –≤—ã—Ä—É—á–∫–µ</option>
              <option value="cups" {% if filters.sort == 'cups' %}selected{% endif %}>–ü–æ —á–∞—à–∫–∞–º</option>
              <option value="packages" {% if filters.sort == 'packages' %}selected{% endif %}>–ü–æ —É–ø–∞–∫–æ–≤–∫–∞–º</option>
            </select>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('sales', load=1) }}">–°–±—Ä–æ—Å–∏—Ç—å</a>
          </div>
        </form>
      </div>
    </div>

    <div class="row mb-4 g-3">
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <span class="metric-label">–ú–∞–≥–∞–∑–∏–Ω—ã</span>
          <span class="metric-value">{{ summary.stores_count or 0 }}</span>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <span class="metric-label">–ß–∞—à–∫–∏</span>
          <span class="metric-value">{{ '{:,}'.format(summary.total_cups or 0).replace(',', ' ') }}</span>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <span class="metric-label">–í—ã—Ä—É—á–∫–∞, ‚Çæ</span>
          <span class="metric-value">{{ '{:,.2f}'.format(summary.total_cash or 0).replace(',', ' ') }}</span>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <span class="metric-label">–£–ø–∞–∫–æ–≤–∫–∏, –∫–≥</span>
          <span class="metric-value">{{ '{:,.2f}'.format(summary.total_packages or 0).replace(',', ' ') }}</span>
        </div>
      </div>
    </div>

    {% if pivot and pivot.dates %}
      <div class="card shadow-sm">
        <div class="table-responsive">
          <table class="table table-bordered table-hover mb-0 align-middle pivot-table">
            <thead class="table-light">
              <tr>
                <th class="align-middle">–î–∞—Ç–∞</th>
                {% for store_name in pivot.stores %}
                  <th class="text-center align-middle">{{ store_name }}</th>
                {% endfor %}
                <th class="text-center align-middle bg-light fw-bold">–ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å</th>
              </tr>
            </thead>
            <tbody>
              {% for current_date in pivot.dates %}
                <tr>
                  <th class="align-middle">{{ current_date.isoformat() }}</th>
                  {% for store_name in pivot.stores %}
                    {% set cell = pivot.data.get(current_date, {}).get(store_name) %}
                    <td class="pivot-cell">
                      {% if cell %}
                        {% if cell.cups > 0 %}
                          <div class="cup-types-group">
                            <div><span class="pivot-label">CCup:</span> <strong class="{% if cell.caotina_cup == 0 %}text-muted{% endif %}">{{ cell.caotina_cup }}</strong></div>
                            <div><span class="pivot-label">MCup:</span> <strong class="{% if cell.mono_cup == 0 %}text-muted{% endif %}">{{ cell.mono_cup }}</strong></div>
                            <div><span class="pivot-label">BCup:</span> <strong class="{% if cell.blend_cup == 0 %}text-muted{% endif %}">{{ cell.blend_cup }}</strong></div>
                            {% set total_cups_display = cell.all_cup if cell.all_cup > 0 else (cell.mono_cup + cell.blend_cup + cell.caotina_cup) %}
                            {% if total_cups_display == 0 %}{% set total_cups_display = cell.cups %}{% endif %}
                            <div class="mt-1 border-top pt-1"><span class="pivot-label">üìä –í—Å–µ–≥–æ:</span> <strong>{{ total_cups_display }}</strong></div>
                          </div>
                        {% else %}
                          <div><span class="pivot-label">–ß–∞—à–∫–∏:</span> {{ cell.cups }}</div>
                        {% endif %}
                        {% if cell.packages_kg > 0 %}<div class="pivot-value-large"><span class="pivot-label-large">üì¶</span> {{ '{:,.2f}'.format(cell.packages_kg).replace(',', ' ') }}–∫–≥</div>{% endif %}
                        <div class="pivot-value-large"><span class="pivot-label-large">üí∞</span> {{ '{:,.2f}'.format(cell.total_cash).replace(',', ' ') }} ‚Çæ</div>
                      {% else %}
                        <span class="text-muted">‚Äî</span>
                      {% endif %}
                    </td>
                  {% endfor %}
                  {% set daily_total = pivot.get_daily_total(current_date) %}
                  <td class="pivot-cell bg-light fw-bold">
                    {% if daily_total %}
                      {% if daily_total.cups > 0 %}
                        <div class="cup-types-group">
                          <div><span class="pivot-label">CCup:</span> <strong class="{% if daily_total.caotina_cup == 0 %}text-muted{% endif %}">{{ daily_total.caotina_cup }}</strong></div>
                          <div><span class="pivot-label">MCup:</span> <strong class="{% if daily_total.mono_cup == 0 %}text-muted{% endif %}">{{ daily_total.mono_cup }}</strong></div>
                          <div><span class="pivot-label">BCup:</span> <strong class="{% if daily_total.blend_cup == 0 %}text-muted{% endif %}">{{ daily_total.blend_cup }}</strong></div>
                          {% set total_cups_display = daily_total.all_cup if daily_total.all_cup > 0 else (daily_total.mono_cup + daily_total.blend_cup + daily_total.caotina_cup) %}
                          {% if total_cups_display == 0 %}{% set total_cups_display = daily_total.cups %}{% endif %}
                          <div class="mt-1 border-top pt-1"><span class="pivot-label">üìä –í—Å–µ–≥–æ:</span> <strong>{{ total_cups_display }}</strong></div>
                        </div>
                      {% else %}
                        <div><span class="pivot-label">–ß–∞—à–∫–∏:</span> <strong>{{ daily_total.cups }}</strong></div>
                      {% endif %}
                      {% if daily_total.packages_kg > 0 %}<div class="pivot-value-large"><span class="pivot-label-large">üì¶</span> <strong>{{ '{:,.2f}'.format(daily_total.packages_kg).replace(',', ' ') }}–∫–≥</strong></div>{% endif %}
                      <div class="pivot-value-large"><span class="pivot-label-large">üí∞</span> <strong>{{ '{:,.2f}'.format(daily_total.total_cash).replace(',', ' ') }} ‚Çæ</strong></div>
                    {% else %}
                      <span class="text-muted">‚Äî</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="card shadow-sm">
        <div class="card-body text-center text-muted py-5">
          –î–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
        </div>
      </div>
    {% endif %}
  {% else %}
    <div class="card shadow-sm">
      <div class="card-body text-center py-5">
        <p class="lead mb-3">–î–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</p>
        <p class="text-muted mb-4">–ú—ã –Ω–µ –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ Proxy API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.</p>
        <a href="{{ url_for('sales', load=1, start_date=filters.start_date, end_date=filters.end_date, sort=filters.sort) }}" class="btn btn-primary btn-lg">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</a>
      </div>
    </div>
  {% endif %}
{% endblock %}

