{% extends "base.html" %}

{% block content %}
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
    <div>
      <h1 class="h3 mb-1">Granite Sales Dashboard</h1>
      <p class="text-muted mb-0">Нажмите кнопку, чтобы загрузить актуальные данные.</p>
    </div>
    <div class="mt-3 mt-md-0">
      <a href="{{ url_for('dashboard', load=1) }}" class="btn btn-primary">
        Загрузить данные
      </a>
    </div>
  </div>

  {% if loaded %}
    <div class="row mb-4">
      <div class="col-12 col-md-6 col-lg-3 mb-3">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title text-uppercase text-muted">Магазины</h6>
            <h2 class="card-text">{{ summary.stores_count or 0 }}</h2>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3 mb-3">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title text-uppercase text-muted">Продано чашек</h6>
            <h2 class="card-text">{{ '{:,}'.format(summary.total_cups or 0).replace(',', ' ') }}</h2>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3 mb-3">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title text-uppercase text-muted">Выручка, ₾</h6>
            <h2 class="card-text">{{ '{:,.2f}'.format(summary.total_cash or 0).replace(',', ' ') }}</h2>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3 mb-3">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title text-uppercase text-muted">Упаковок, кг</h6>
            <h2 class="card-text">{{ '{:,.2f}'.format(summary.total_packages or 0).replace(',', ' ') }}</h2>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div>
          <h5 class="card-title mb-1">Диапазон дат</h5>
          <p class="card-text text-muted mb-0">
            {{ summary.start_date or filters.start_date }} — {{ summary.end_date or filters.end_date }}
          </p>
        </div>
        <div class="mt-3 mt-md-0">
          <a href="{{ url_for('sales', load=1, start_date=filters.start_date, end_date=filters.end_date) }}" class="btn btn-outline-primary">
            Перейти к деталям
          </a>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
          <span>Последние записи</span>
          <span class="badge bg-secondary">{{ preview|length }}</span>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped mb-0">
          <thead>
            <tr>
              <th>Магазин</th>
              <th>Дата</th>
              <th>Чашек</th>
              <th>Выручка, ₾</th>
              <th>Упаковок, кг</th>
            </tr>
          </thead>
          <tbody>
            {% for record in preview %}
              <tr>
                <td>{{ record.store_name }}</td>
                <td>{{ record.order_date.isoformat() }}</td>
                <td>{{ record.cups }}</td>
                <td>{{ '{:,.2f}'.format(record.total_cash).replace(',', ' ') }}</td>
                <td>{{ '{:,.2f}'.format(record.packages_kg).replace(',', ' ') }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">Нет данных для отображения</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="mt-4">
      <small class="text-muted">
        Состояние API: {{ health.status or 'unknown' }}
        {% if health.message %}— {{ health.message }}{% endif %}
      </small>
    </div>
  {% else %}
    <div class="card shadow-sm">
      <div class="card-body text-center py-5">
        <p class="lead mb-3">Данные пока не загружены.</p>
        <p class="text-muted mb-4">Мы не выполняем запросы к Proxy API автоматически. Используйте кнопку выше, чтобы получить актуальную статистику.</p>
        <a href="{{ url_for('dashboard', load=1) }}" class="btn btn-primary btn-lg">Загрузить данные</a>
      </div>
    </div>
  {% endif %}
{% endblock %}

